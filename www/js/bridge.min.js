'use strict';var Bridge={directions:{n:{name:"North",lho:"e",rho:"w",cho:"s",index:1,html:"North"},e:{name:"East",lho:"s",rho:"n",cho:"w",index:2,html:"East"},s:{name:"South",lho:"w",rho:"e",cho:"n",index:3,html:"South"},w:{name:"West",lho:"n",rho:"s",cho:"e",index:0,html:"West"}},directionOrder:[],suits:{s:{name:"Spades",index:0,html:'<span class="suit-spades">&spades;</span>'},h:{name:"Hearts",index:1,html:'<span class="suit-hearts">&hearts;</span>'},d:{name:"Diamonds",index:2,html:'<span class="suit-diamonds">&diams;</span>'},
c:{name:"Clubs",index:3,html:'<span class="suit-clubs">&clubs;</span>'}},suitOrder:[],calls:{n:{name:"No Trump",index:0,isStrain:!0,bid:!0,text:"NT",html:'<span class="suit-NT">NT</span>'},s:{name:"Spades",index:1,isStrain:!0,bid:!0,text:"&spades;",html:'<span class="suit-spades">&spades;</span>'},h:{name:"Hearts",index:2,isStrain:!0,bid:!0,text:"&hearts;",html:'<span class="suit-hearts">&hearts;</span>'},d:{name:"Diamonds",index:3,isStrain:!0,bid:!0,text:"&diams;",html:'<span class="suit-diamonds">&diams;</span>'},
c:{name:"Clubs",index:4,isStrain:!0,bid:!0,text:"&clubs;",html:'<span class="suit-clubs">&clubs;</span>'},p:{name:"Pass",index:7,isStrain:!1,bid:!1,text:"P",html:'<span class="bid-pass">P</span>'},x:{name:"Double",index:6,isStrain:!1,bid:!1,text:"X",html:'<span class="bid-double">X</span>'},r:{name:"Redouble",index:5,isStrain:!1,bid:!1,text:"XX",html:'<span class="bid-redouble">XX</span>'}},callOrder:[],ranks:{a:{name:"Ace",index:0,html:"A"},k:{name:"King",index:1,html:"K"},q:{name:"Queen",index:2,
html:"Q"},j:{name:"Jack",index:3,html:"J"},t:{name:"Ten",index:4,html:"T"},9:{name:"Nine",index:5,html:"9"},8:{name:"Eight",index:6,html:"8"},7:{name:"Seven",index:7,html:"7"},6:{name:"Six",index:8,html:"6"},5:{name:"Five",index:9,html:"5"},4:{name:"Four",index:10,html:"4"},3:{name:"Three",index:11,html:"3"},2:{name:"Two",index:12,html:"2"}},rankOrder:[],vulnerabilities:{"-":{name:"None",index:0,html:"None"},n:{name:"NS",index:0,html:"North-South"},e:{name:"EW",index:0,html:"East-West"},b:{name:"Both",
index:0,html:"Both"}},_addKey:function(a){for(var b in a)a[b].key=b},_createIndexArray:function(a){var b=[],c;for(c in a)b[a[c].index]=c;return b},_checkListMembership:function(a,b,c,d){_.has(b,a)||Bridge._reportError(a+" is not a valid "+c,d)},_belongsTo:function(a,b){return _.has(b,a)},_checkRequiredArgument:function(a,b,c){a||""===a||Bridge._reportError("Required argument "+b+" has not been specified",c)}};Bridge._addKey(Bridge.directions);Bridge._addKey(Bridge.suits);Bridge._addKey(Bridge.calls);
Bridge._addKey(Bridge.ranks);Bridge._addKey(Bridge.vulnerabilities);Bridge.directionOrder=Bridge._createIndexArray(Bridge.directions);Bridge.suitOrder=Bridge._createIndexArray(Bridge.suits);Bridge.callOrder=Bridge._createIndexArray(Bridge.calls);Bridge.rankOrder=Bridge._createIndexArray(Bridge.ranks);Bridge.options={useContextInErrorMessage:!1,enableDebug:!1};Bridge.isHigherRank=function(a,b){return Bridge.ranks[a].index<Bridge.ranks[b].index};
Bridge.isNorthSouth=function(a){return"n"===a||"s"===a};Bridge.isEastWest=function(a){return"e"===a||"w"===a};Bridge.getLHO=function(a){return Bridge.directions[a].lho};Bridge.getRHO=function(a){return Bridge.directions[a].rho};Bridge.getPartner=function(a){return Bridge.directions[a].cho};Bridge.areOpponents=function(a,b){return Bridge.getLHO(a)===b||Bridge.getRHO(a)===b};Bridge.arePartners=function(a,b){return Bridge.getPartner(a)===b};
Bridge.makeIdentifier=function(a){return a.trim().replace(/[^a-zA-Z0-9]+/g,"_")};Bridge.assignDefault=function(a,b){return"undefined"===typeof a?b:a};Bridge.getHash=function(a){return Bridge._getParameters(location.hash,"#",a)};Bridge.getQuery=function(a){return Bridge._getQuery(document.URL,a)};Bridge._getQuery=function(a,b){return Bridge._getParameters(a,"?",b)};
Bridge._getParameters=function(a,b,c){a=a.split(b);if(2>a.length)return{};a=a[1];c&&(a=a.split(c)[0]);return Bridge._parseParameterValues(a,"&","=")};Bridge._parseParameterValues=function(a,b,c){b=Bridge.assignDefault(b,"&");c=Bridge.assignDefault(c,"=");var d={};a=a.trim();if(!a)return d;a=a.split(b);for(b=0;b<a.length;++b){var e=a[b].split(c);2>e.length?d[e]=!0:d[e[0]]=e[1]}return d};
Bridge._parseContainedText=function(a,b,c,d){var e={};e.position=a.indexOf(c,b);-1===e.position&&Bridge._reportError("Ending delimiter "+c+" not found in "+a,d);e.text=a.slice(b+1,e.position);return e};Bridge._reportError=function(a,b){if(!Bridge.options.useContextInErrorMessage)throw Error(a);throw Error((b?b+" - ":"")+a);};Bridge._checkDirection=function(a,b){Bridge._checkListMembership(a,Bridge.directions,"Direction",b)};Bridge.isDirection=function(a){return Bridge._belongsTo(a,Bridge.directions)};
Bridge._checkSuit=function(a,b){Bridge._checkListMembership(a,Bridge.suits,"Suit",b)};Bridge.isSuit=function(a){return Bridge._belongsTo(a,Bridge.suits)};Bridge._checkStrain=function(a,b){Bridge._checkListMembership(a,Bridge.calls,"Strain",b);Bridge.calls[a].isStrain||Bridge._reportError("Strain "+a+" is not a valid strain!",b)};Bridge.isStrain=function(a){return _.has(Bridge.calls,a)&&Bridge.calls[a].isStrain};
Bridge._checkCard=function(a,b){a&&2===a.length||Bridge._reportError("Card "+a+" does not have length 2",b);Bridge._checkSuit(a[0],b);Bridge._checkRank(a[1],b)};Bridge.isCard=function(a){if(!a||2!==a.length)return!1;var b=a[1];return Bridge.isSuit(a[0])&&Bridge.isRank(b)};Bridge._checkCall=function(a,b){Bridge._checkListMembership(a,Bridge.calls,"Call",b)};Bridge.isCall=function(a){return Bridge._belongsTo(a,Bridge.calls)};
Bridge._checkLevel=function(a,b){var c=parseInt(a);(isNaN(c)||String(c)!==String(a)||1>c||7<c)&&Bridge._reportError(a+" is not a valid level",b)};Bridge.isLevel=function(a){var b=parseInt(a);return isNaN(b)||String(b)!==String(a)||1>b||7<b?!1:!0};
Bridge._checkBid=function(a,b){(1>a.length||2<a.length)&&Bridge._reportError("Bid "+a+" does not have length 1 or 2",b);if(1===a.length){var c=a[0];Bridge._checkCall(c,b);Bridge.isStrain(c)&&Bridge._reportError("Invalid bid "+a,b)}else{var d=a[0],c=a[1];Bridge._checkCall(c,b);Bridge.isStrain(c)||Bridge._reportError("Invalid bid "+a,b);Bridge._checkLevel(d,b)}};
Bridge.isBid=function(a){if(1>a.length||2<a.length)return!1;if(1===a.length)return a=a[0],Bridge.isCall(a)&&!Bridge.isStrain(a);var b=a[0];a=a[1];return Bridge.isLevel(b)&&Bridge.isCall(a)&&Bridge.isStrain(a)};Bridge._checkRank=function(a,b){Bridge._checkListMembership(a,Bridge.ranks,"Rank",b)};Bridge.isRank=function(a){return Bridge._belongsTo(a,Bridge.ranks)};Bridge._checkVulnerability=function(a,b){Bridge._checkListMembership(a,Bridge.vulnerabilities,"Vulnerability",b)};
Bridge.isVulnerability=function(a){return Bridge._belongsTo(a,Bridge.vulnerabilities)};Bridge._checkIndex=function(a,b,c){b>=a.length&&Bridge._reportError("array does not have item at index "+b,c)};Bridge||(Bridge={});Bridge.Deal=function(){this.cards={};for(var a in Bridge.suits){this.cards[a]={};for(var b in Bridge.ranks)this.cards[a][b]=new Bridge.Card(a,b)}this.hands={};for(var c in Bridge.directions)this.hands[c]=new Bridge.Hand(c,this);this._activeHand="n";this.board=1;this.vulnerability="-";this.dealer="n";this.scoring="KO";this.notes="";this.auction=new Bridge.Auction(this);this.play=new Bridge.Play(this);this.triggerEvents=!0};
Bridge.Deal.prototype.enableEventTrigger=function(){this.triggerEvents=!0};Bridge.Deal.prototype.disableEventTrigger=function(){this.triggerEvents=!1};Bridge.Deal.prototype.getHand=function(a){Bridge._checkDirection(a);return this.hands[a]};Bridge.Deal.prototype.getActiveHand=function(){return this._activeHand};
Bridge.Deal.prototype.setActiveHand=function(a){Bridge._checkDirection(a);this.getHand(this.getActiveHand()).makeInactive();this._activeHand=a;this.getHand(a).makeActive();this.onChange("setActiveHand",a)};Bridge.Deal.prototype.getBoard=function(){return this.board};Bridge.Deal.prototype.setBoard=function(a){var b=parseInt(a);(isNaN(b)||String(b)!==String(a)||1>b)&&Bridge.Utilities.reportError(a+" is not a valid board number","In setBoard");this.board=b;this.onChange("setBoard",this.board)};
Bridge.Deal.prototype.getDealer=function(){return this.dealer};Bridge.Deal.prototype.setDealer=function(a){a=a.toLowerCase();Bridge._checkDirection(a);this.dealer=a;this.getAuction().setDealer(a);this.onChange("setDealer",a)};Bridge.Deal.prototype.getVulnerability=function(){return this.vulnerability};
Bridge.Deal.prototype.setVulnerability=function(a){a=a.toLowerCase();"0"===a&&(a="-");Bridge._checkVulnerability(a);this.vulnerability=a;this.getAuction().setVulnerability(a);this.onChange("setVulnerability",a)};Bridge.Deal.prototype.getScoring=function(){return this.scoring};Bridge.Deal.prototype.setScoring=function(a){Bridge._checkRequiredArgument(a);this.scoring=a;this.onChange("setScoring",a)};Bridge.Deal.prototype.getNotes=function(){return this.notes};
Bridge.Deal.prototype.setNotes=function(a){Bridge._checkRequiredArgument(a);this.notes=a;this.onChange("setNotes",a)};Bridge.Deal.prototype.getAuction=function(){return this.auction};Bridge.Deal.prototype.getPlay=function(){return this.play};
Bridge.Deal.prototype.set=function(a,b){Bridge._checkRequiredArgument(a,"Property","In Bridge.Deal.prototype.set");Bridge._checkRequiredArgument(b,"Value for Property "+a,"In Bridge.Deal.prototype.set");switch(a){case "board":this.setBoard(b);break;case "vulnerability":this.setVulnerability(b);break;case "dealer":this.setDealer(b);break;case "scoring":this.setScoring(b);break;case "notes":this.setNotes(b);break;default:Bridge._reportError("Unknown deal property "+a,"In Bridge.Deal.prototype.set")}};
Bridge.Deal.prototype.get=function(a){Bridge._checkRequiredArgument(a,"Property","In Bridge.Deal.prototype.get - ");switch(a){case "board":return this.getBoard();case "vulnerability":return this.getVulnerability();case "dealer":return this.getDealer();case "scoring":return this.getScoring();case "notes":return this.getNotes();case "auction":return this.getAuction();case "play":return this.getPlay();default:Bridge._reportError("Unknown deal property "+a,"In Bridge.Deal.prototype.get - ")}};
Bridge.Deal.prototype.assignRest=function(){var a=[],b;for(b in Bridge.suits)for(var c in Bridge.ranks)this.cards[b][c].isAssigned()||a.push(b+c);if(!_.isEmpty(a)){var a=_.shuffle(a),d="n",e=null;_.each(a,function(a){for(;13===this.getHand(d).getCount();)e||(e=d),d=Bridge.getLHO(d),e===d&&Bridge._reportError("Unable to assign remaining cards");this.getHand(d).addCard(a[0],a[1])},this)}};
Bridge.Deal.prototype.fromString=function(a){var b={};_.each(a.split("&"),function(a){a=a.split("=");b[a[0]]=decodeURIComponent(a[1])});var c=0;_.each(b,function(a,b){switch(b){case "b":this.set("board",a);break;case "d":this.set("dealer",a);break;case "v":this.set("vulnerability",a);break;case "t":this.set("notes",a);break;case "a":var f=this.getAuction();"-"===a[0]?f.setContract(a.slice(1)):f.setAuction(a);break;case "p":this.getPlay().fromString(a);break;case "n":case "e":case "s":case "w":f=this.getHand(b);
f.setHand(a);13===f.getCount()&&c++;break;case "nn":case "en":case "sn":case "wn":f=this.getHand(b[0]),f.setName(a)}},this);3===c&&this.assignRest()};
Bridge.Deal.prototype.toString=function(a){a=Bridge.assignDefault(a,!1);var b=[];this.board&&b.push("b="+this.getBoard());this.dealer&&b.push("d="+this.getDealer());this.vulnerability&&b.push("v="+this.getVulnerability());a&&this.notes&&b.push("t="+this.getNotes());for(var c in Bridge.directions)(a=this.getHand(c))&&b.push(c+"="+a),b.push(c+"n="+a.getName());(c=this.getAuction().toString())&&b.push("a="+c);(c=this.getPlay().toString())&&b.push("p="+c);return b.join("&")};
Bridge.Deal.prototype.toJSON=function(){var a={version:"1.0"};_.each(["board","dealer","vulnerability","scoring","notes"],function(b){a[b]=this.get(b)},this);a.hands={};for(var b in Bridge.directions){var c=this.getHand(b);a.hands[b]=c.toJSON()}a.auction=this.getAuction().toJSON();a.play=this.getPlay().toJSON();return a};
Bridge.Deal.prototype.fromJSON=function(a){_.each(["board","dealer","vulnerability","scoring","notes"],function(b){_.has(a,b)&&this.set(b,a[b])},this);if(_.has(a,"hands"))for(var b in Bridge.directions)_.has(a.hands,b)&&this.getHand(b).fromJSON(a.hands[b]);_.has(a,"auction")&&this.getAuction().fromJSON(a.auction);_.has(a,"play")&&this.getPlay().fromJSON(a.play)};
Bridge.Deal.prototype.fromLIN=function(a){a=a.split("|");for(var b=["s","w","n","e"],c=0;c<a.length;++c)switch(_.startsWith(a[c].toLowerCase(),"board")&&this.setBoard(a[c].trim().slice(5).trim()),a[c].toLowerCase()){case "pn":Bridge._checkIndex(a,c+1,"In Bridge.Deal.fromLin - processing pn - ");for(var d=a[c+1].split(","),e=0;e<b.length;++e)if(e<d.length){var f=b[e],l=d[e];_.startsWith(l,"~~")&&(l="Robot");this.getHand(f).setName(l)}break;case "md":Bridge._checkIndex(a,c+1,"In Bridge.Deal.fromLin - processing md - ");
d=a[c+1].split(",");this.setDealer({1:"s",2:"w",3:"n",4:"e"}[d[0][0]]);l=d[0].slice(1);f="s";this.getHand(f).setHand(l);for(e=1;e<d.length;++e)f=Bridge.getLHO(f),l=d[e],this.getHand(f).setHand(l);this.assignRest();break;case "mb":Bridge._checkIndex(a,c+1,"In Bridge.Deal.fromLin - processing mb - ");e=a[c+1].slice(0,2).toLowerCase();"d"===e&&(e="x");f=null;c+2<a.length&&"an"===a[c+2].toLowerCase()&&(f=a[c+3],f=f.replace("(",""),f=f.replace(")",""));this.getAuction().addCall(e,null,f);break;case "pc":Bridge._checkIndex(a,
c+1,"In Bridge.Deal.fromLin - processing pc - ");e=a[c+1].slice(0,2);this.getPlay().addPlayedCard(e[0],e[1]);break;case "sv":Bridge._checkIndex(a,c+1,"In Bridge.Deal.fromLin - processing sv - "),e=a[c+1],"o"===e&&(e="-"),this.setVulnerability(e)}};Bridge.Deal.prototype.onChange=function(a,b){this.triggerEvents&&(Bridge.options.enableDebug&&console.log("deal:changed "+a+" - "+b),$(document).trigger("deal:changed",[this,a,b]))};Bridge||(Bridge={});Bridge.Card=function(a,b){Bridge._checkSuit(a);this.suit=a;Bridge._checkRank(b);this.rank=b;this.direction=null;this.played=!1};Bridge.Card.prototype.getSuit=function(){return this.suit};Bridge.Card.prototype.getRank=function(){return this.rank};Bridge.Card.prototype.getDirection=function(){return this.direction};Bridge.Card.prototype.setDirection=function(a){Bridge._checkDirection(a);this.direction=a};Bridge.Card.prototype.assign=function(a){this.setDirection(a)};
Bridge.Card.prototype.unAssign=function(){this.direction=null};Bridge.Card.prototype.isAssigned=function(){return null!==this.direction};
Bridge.Card.prototype.play=function(a){this.direction||Bridge._reportError("Cannot play card : "+this.getSuit()+this.getRank()+" since it is not assigned to any direction","In Card.play");a!==this.direction&&Bridge._reportError("Cannot play card : "+this.getSuit()+this.getRank()+" since it is does not belong to "+a,"In Card.play");this.played&&Bridge._reportError("Cannot play card : "+this.getSuit()+this.getRank()+" since it is already played","In Card.play");this.played=!0};
Bridge.Card.prototype.get=function(a){Bridge._checkRequiredArgument(a,"Property","In Card.get");switch(a){case "suit":return this.getSuit();case "rank":return this.getRank();case "direction":return this.getDirection();default:Bridge._reportError("Unknown property "+a,"In Card.get")}};
Bridge.Card.prototype.set=function(a,b){Bridge._checkRequiredArgument(a,"Property","In Card.set");Bridge._checkRequiredArgument(b,"Value for Property "+a,"In Card.set");switch(a){case "direction":return this.setDirection(b);default:Bridge._reportError("Unknown property "+a,"In Card.set")}};Bridge.Card.prototype.toString=function(){return this.suit+this.rank};Bridge||(Bridge={});Bridge.Hand=function(a,b){Bridge._checkDirection(a);this.direction=a;this.deal=b;this.name=Bridge.directions[a].name;this.cards={};for(var c in Bridge.suits){this.cards[c]={};for(var d in Bridge.ranks)this.cards[c][d]=!1}this.showAsX={};for(c in Bridge.suits)for(d in this.showAsX[c]={},Bridge.ranks)this.showAsX[c][d]=!1;this.numCards=0;this._isActive=!1;this.triggerEvents=!0};Bridge.Hand.prototype.enableEventTrigger=function(){this.triggerEvents=!0};
Bridge.Hand.prototype.disableEventTrigger=function(){this.triggerEvents=!1};Bridge.Hand.prototype.makeActive=function(){this._isActive=!0;this.onChange("makeActive")};Bridge.Hand.prototype.makeInactive=function(){this._isActive=!1;this.onChange("makeInactive")};Bridge.Hand.prototype.getDirection=function(){return this.direction};Bridge.Hand.prototype.setName=function(a){Bridge._checkRequiredArgument(a);this.name=a;this.onChange("setName",a)};Bridge.Hand.prototype.getName=function(){return this.name};
Bridge.Hand.prototype.getCount=function(){return this.numCards};Bridge.Hand.prototype.setHand=function(a){Bridge._checkRequiredArgument(a);this.fromString(a)};Bridge.Hand.prototype.getHand=function(){return this.toString()};Bridge.Hand.prototype.getCards=function(a){Bridge._checkSuit(a);var b="";_.each(Bridge.rankOrder,function(c){this.cards[a][c]&&(b=this.showAsX[a][c]?b+"x":b+c)},this);return b};
Bridge.Hand.prototype.addCard=function(a,b){Bridge._checkSuit(a,"In addCard");var c=!1;if("string"===typeof b&&"x"===b.toLowerCase())for(var d=Bridge.rankOrder.length-1;0<=d;--d){var e=Bridge.rankOrder[d];if(this.deal){var f=this.deal.cards[a][e];f.isAssigned()||(b=e,c=!0,d=-1)}else this.cards[a][e]||(b=e,c=!0,d=-1)}Bridge._checkRank(b,"In addCard");13===this.numCards&&Bridge._reportError(this.name+"'s Hand : already has 13 cards. Cannot add "+a+b,"In addCard");this.cards[a][b]&&Bridge._reportError(a+
b+" is already assigned to "+this.direction+". Cannot add again","In addCard");this.deal&&(f=this.deal.cards[a][b],f.isAssigned()&&Bridge._reportError(a+b+" is already assigned to "+f.getDirection()+". Cannot add again","In addCard"));this.cards[a][b]=!0;this.showAsX[a][b]=c;this.deal&&this.deal.cards[a][b].assign(this.direction);this.numCards++;this.onChange("addCard",a+b)};
Bridge.Hand.prototype.removeCard=function(a,b){Bridge._checkSuit(a,"In removeCard");Bridge._checkRank(b,"In removeCard");this.deal&&(this.deal.cards[a][b].isAssigned()||Bridge._reportError(a+b+" is not assigned to "+this.direction+". Cannot remove","In removeCard"));this.cards[a][b]||Bridge._reportError(a+b+" is not assigned to "+this.direction+". Cannot remove","In removeCard");this.cards[a][b]=!1;this.numCards--;this.deal&&this.deal.cards[a][b].unAssign();this.onChange("removeCard",a+b)};
Bridge.Hand.prototype.hasCard=function(a,b){Bridge._checkSuit(a,"In hasCard");Bridge._checkRank(b,"In hasCard");return this.cards[a][b]};Bridge.Hand.prototype.clearCards=function(){for(var a in Bridge.suits)for(var b in Bridge.ranks)this.cards[a][b]&&this.removeCard(a,b)};
Bridge.Hand.prototype.set=function(a,b){Bridge._checkRequiredArgument(a,"Property","In Hand.set");Bridge._checkRequiredArgument(b,"Value for Property "+a,"In Hand.set");switch(a){case "name":this.setName(b);break;case "hand":this.setHand(b);break;default:Bridge._reportError("Unknown property "+a,"In Hand.set")}};
Bridge.Hand.prototype.get=function(a){Bridge._checkRequiredArgument(a,"Property","In Hand.get");switch(a){case "direction":return this.getDirection();case "name":return this.getName();case "count":return this.getCount();case "hand":return this.getHand();default:Bridge._reportError("Unknown property "+a,"In Hand.get")}};
Bridge.Hand.prototype.toString=function(){var a="";_.each(Bridge.suitOrder,function(b){var c="";_.each(Bridge.rankOrder,function(a){this.cards[b][a]&&(c=this.showAsX[b][a]?c+"x":c+a)},this);c&&(a+=b+c)},this);return a};
Bridge.Hand.prototype.fromString=function(a){Bridge._checkRequiredArgument(a);this.clearCards();var b={},c;for(c in Bridge.directions)b[c]=!1;a=a.toLowerCase();for(var d=c="",e=0;e<a.length;++e){var d="In hand for "+this.direction+" at position "+(e+1),f=a.charAt(e);switch(f){case "c":case "d":case "h":case "s":c=f;b[c]&&Bridge._reportError(" suit "+c+" has already been seen before!",d);b[c]=!0;break;case "1":""===c&&Bridge._reportError(f+" was found when a suit was expected!",d);if(e<a.length-1&&
"0"===a.charAt(e+1))d="t",e++;else{Bridge._reportError("a 1 is present without a subsequent 0. Use 10 or t to reprensent the ten.",d);continue}this.addCard(c,d);break;default:if(""===c){Bridge._reportError(f+" was found when a suit was expected!",d);continue}d=f;this.addCard(c,d)}}};Bridge.Hand.prototype._hasCards=function(a){for(var b in Bridge.ranks)if(this.cards[a][b])return!0;return!1};
Bridge.Hand.prototype.getAlternatingSuitOrder=function(){var a=0,b={};_.each(Bridge.suitOrder,function(c){b[c]=this._hasCards(c);b[c]&&a++},this);return 3>a?Bridge.suitOrder:4===a?["h","s","d","c"]:b.s&&b.c?Bridge.suitOrder:["h","s","c","d"]};Bridge.Hand.prototype.toJSON=function(){var a={};a.direction=this.direction;a.name=this.name;a.hand=this.getHand();return a};Bridge.Hand.prototype.fromJSON=function(a){Bridge._checkRequiredArgument(a);this.name=a.name;this.setHand(a.hand)};
Bridge.Hand.prototype.onChange=function(a,b){if(this.triggerEvents&&!this.deal||this.deal.triggerEvents)Bridge.options.enableDebug&&console.log("hand:changed "+a+" - "+b),$(document).trigger("hand:changed",[this,a,b]);this.deal&&this.deal.triggerEvents&&(Bridge.options.enableDebug&&console.log("deal:changed "+a+" - "+b),$(document).trigger("deal:changed",[this.deal,a,b]))};Bridge||(Bridge={});Bridge.Call=function(a,b){Bridge._checkBid(a);Bridge._checkDirection(b);this.call=a;this.direction=b;this.explanation=this.annotation=""};Bridge.Call.prototype.getCall=function(){return this.call};Bridge.Call.prototype.getLevel=function(){return 1===this.call.length?0:_.parseInt(this.call[0])};Bridge.Call.prototype.getSuit=function(){return 1===this.call.length?this.call[0]:this.call[1]};Bridge.Call.prototype.setDirection=function(a){Bridge._checkDirection(a);this.direction=a};
Bridge.Call.prototype.getDirection=function(){return this.direction};Bridge.Call.prototype.getAnnotation=function(){return this.annotation};Bridge.Call.prototype.setAnnotation=function(a){Bridge._checkRequiredArgument(a);this.annotation=a};Bridge.Call.prototype.getExplanation=function(){return this.explanation};Bridge.Call.prototype.setExplanation=function(a){Bridge._checkRequiredArgument(a);this.explanation=a};
Bridge.Call.prototype.set=function(a,b){Bridge._checkRequiredArgument(a,"Property","In Call.set");Bridge._checkRequiredArgument(b,"Value for Property "+a,"In Call.set");switch(a){case "direction":this.setDirection(b);break;case "annotation":this.setAnnotation(b);break;case "explanation":this.setExplanation(b);break;default:Bridge._reportError("Unknown property "+a,"In Call.set")}};
Bridge.Call.prototype.get=function(a){Bridge._checkRequiredArgument(a,"Property","In Call.get");switch(a){case "call":return this.getCall();case "direction":return this.getDirection();case "annotation":return this.getAnnotation();case "explanation":return this.getExplanation();default:Bridge._reportError("Unknown property "+a,"In Call.get")}};
Bridge.Call.prototype.toString=function(){var a;a=""+this.call;this.explanation&&(a+="{"+this.explanation+"}");this.annotation&&(a+="("+this.annotation+")");return a};Bridge||(Bridge={});Bridge.Auction=function(a){this.dealer=(this.deal=a)?a.getDealer():"n";this.vulnerability=a?a.getVulnerability():"-";this.nextToCall=this.dealer;this.calls=[];this.contracts=[];this.selectedLevel=0;this.triggerEvents=!0};Bridge.Auction.prototype.enableEventTrigger=function(){this.triggerEvents=!0};Bridge.Auction.prototype.disableEventTrigger=function(){this.triggerEvents=!1};Bridge.Auction.prototype.getNextToCall=function(){return this.nextToCall};
Bridge.Auction.prototype.getDealer=function(){return this.dealer};Bridge.Auction.prototype.setDealer=function(a){Bridge._checkDirection(a);var b=this.dealer=a;_.each(this.calls,function(a){a.setDirection(b);b=Bridge.getLHO(b)},this);this.nextToCall=b;this.onChange("changed dealer to "+a)};Bridge.Auction.prototype.getVulnerability=function(){return this.vulnerability};
Bridge.Auction.prototype.setVulnerability=function(a){Bridge._checkVulnerability(a);this.vulnerability=a;this.onChange("setVulnerability",a)};Bridge.Auction.prototype.getSelectedLevel=function(){return this.selectedLevel};Bridge.Auction.prototype.setSelectedLevel=function(a){Bridge._checkLevel(a);this.selectedLevel=a;this.onChange("setSelectedLevel",a)};Bridge.Auction.prototype.unsetSelectedLevel=function(){this.selectedLevel=null;this.onChange("setSelectedLevel",this.selectedLevel)};
Bridge.Auction.prototype.setAuction=function(a){Bridge._checkRequiredArgument(a);this.fromString(a)};Bridge.Auction.prototype.getAuction=function(){return this.toString()};
Bridge.Auction.prototype.setContract=function(a){Bridge._checkRequiredArgument(a);var b=0;a.length<b+1&&Bridge._reportError("Contract string "+a+" does not specify level!","In Bridge.setContract");var c=_.parseInt(a[b++]);a.length<b+1&&Bridge._reportError("Contract string "+a+" does not specify suit!","In Bridge.setContract");var d=a[b++].toLowerCase();Bridge._checkBid(c+d,"In Bridge.setContract");Bridge.isStrain(d)||Bridge._reportError("Contract string "+a+" does not specify a valid suit!","In Bridge.setContract");
var e=!1,f=!1;a.length>b&&"x"===a[b].toLowerCase()&&(e=!0,b++,a.length>b&&"x"===a[b].toLowerCase()&&(f=!0,b++));a.length<b+1&&Bridge._reportError("Contract string "+a+" does not specify declarer!","In Bridge.setContract");a=a[b].toLowerCase();Bridge._checkDirection(a);for(this.clearCalls();this.nextToCall!==a;)this.addCall("p");this.addCall(c+d);e&&this.addCall("x");f&&this.addCall("r");this.addCall("p");this.addCall("p");this.addCall("p")};
Bridge.Auction.prototype.getContract=function(){var a=this.calls.length;return 0===a?new Bridge.Contract:this.contracts[a-1]};
Bridge.Auction.prototype.get=function(a){Bridge._checkRequiredArgument(a,"Property","In Auction.get");switch(a){case "dealer":return this.getDealer();case "vulnerability":return this.getVulnerability();case "level":return this.getSelectedLevel();case "contract":return this.getContract();case "auction":return this.getAuction();default:Bridge._reportError("Unknown deal property "+a,"In Auction.get")}};
Bridge.Auction.prototype.set=function(a,b){Bridge._checkRequiredArgument(a,"Property","In Auction.set");Bridge._checkRequiredArgument(b,"Value for Property "+a,"In Auction.set");switch(a){case "dealer":this.setDealer(b);break;case "vulnerability":this.setVulnerability(b);break;case "level":this.setSelectedLevel(b);case "contract":this.setContract(b);break;case "auction":this.setAuction(b);break;default:Bridge._reportError("Unknown deal property "+a,"In Auction.set")}};
Bridge.Auction.prototype.addCall=function(a,b,c){a=a.toLowerCase();Bridge._checkBid(a,"In Auction.addCall");a=new Bridge.Call(a,this.nextToCall);c&&a.setAnnotation(c);b&&a.setExplanation(b);b=0===this.calls.length?new Bridge.Contract:this.getContract().clone();b.update(a);this.calls.push(a);this.contracts.push(b);this.nextToCall=Bridge.getLHO(this.nextToCall);this.selectedLevel=0;this.onChange("addCall",a);this.getContract().isComplete&&$(document).trigger("auction:complete",this)};
Bridge.Auction.prototype.addAllPass=function(){for(;!this.getContract().isComplete;)this.addCall("p")};Bridge.Auction.prototype.clearCalls=function(){for(;0<this.calls.length;)this.removeCall()};Bridge.Auction.prototype.removeCall=function(){if(0<this.calls.length){var a=this.calls[this.calls.length-1];this.calls.pop();this.contracts.pop();this.nextToCall=Bridge.getRHO(this.nextToCall);this.selectedLevel=0;this.onChange("removeCall",a.getCall())}};
Bridge.Auction.prototype.fromString=function(a){this.clearCalls();for(var b=0;b<a.length;){var c=a[b++].toLowerCase();"d"===c&&(c="x");for(var c=_.has(Bridge.calls,c)&&!Bridge.isStrain(c)?c:c+a[b++].toLowerCase(),d=null,e=null;b<a.length&&("("===a[b]||"{"===a[b]);){if("("===a[b])var f=")",b=Bridge._parseContainedText(a,b,f,"In Auction.fromString"),e=b.text;else f="}",b=Bridge._parseContainedText(a,b,f,"In Auction.fromString"),d=b.text;b=b.position+1}this.addCall(c,d,e)}};
Bridge.Auction.prototype.fromJSON=function(a){return this.fromString(a)};Bridge.Auction.prototype.toString=function(){for(var a="",b=0;b<this.calls.length;++b)a+=this.calls[b].toString();return a};Bridge.Auction.prototype.toJSON=function(){return this.toString()};
Bridge.Auction.prototype.onChange=function(a,b){!this.triggerEvents||this.deal&&!this.deal.triggerEvents||(Bridge.options.enableDebug&&(console.log("auction:changed "+a+" - "+b),console.log("bidding-box:changed "+a+" - "+b)),$(document).trigger("auction:changed",[this,a,b]),$(document).trigger("bidding-box:changed",[this,a,b]));this.deal&&this.deal.triggerEvents&&(Bridge.options.enableDebug&&console.log("deal:changed "+a+" - "+b),$(document).trigger("deal:changed",[this.deal,a,b]))};Bridge||(Bridge={});Bridge.Contract=function(){this.suit=this.level=null;this.redoubled=this.doubled=!1;this.declarer=null;this.firstToBid={};for(var a in Bridge.calls)if(Bridge.isStrain(a)){this.firstToBid[a]={};for(var b in Bridge.directions)this.firstToBid[a][b]=null}this.numPasses=0;this.isComplete=!1};Bridge.Contract.prototype.getSuit=function(){return this.suit};Bridge.Contract.prototype.getDeclarer=function(){return this.declarer};Bridge.Contract.prototype.getLeader=function(){return Bridge.getLHO(this.declarer)};
Bridge.Contract.prototype.allowedCalls=function(a){Bridge._checkDirection(a);var b={};b.p=!this.isComplete;b.ap=b.p;b.x=!1;b.r=!1;for(var c=1;7>=c;++c)for(var d in Bridge.calls)Bridge.isStrain(d)&&(b[c+d]=!this.isComplete);b.u=!(null===this.suit&&0===this.numPasses);b.minimum_level=8;if(null===this.suit||this.isComplete)return this.isComplete||(b.minimum_level=1),b;for(c=1;7>=c;++c)for(d in Bridge.calls)Bridge.isStrain(d)&&(c>this.level||c===this.level&&Bridge.calls[d].index<Bridge.calls[this.suit].index?
(b[c+d]=!0,c<b.minimum_level&&(b.minimum_level=c)):b[c+d]=!1);b.p=!0;b.x=!this.doubled&&!this.redoubled&&Bridge.areOpponents(a,this.declarer);b.r=this.doubled&&!this.redoubled&&!Bridge.areOpponents(a,this.declarer);return b};Bridge.Contract.prototype.clone=function(){var a=new Bridge.Contract;_.each("level suit doubled redoubled declarer numPasses isComplete".split(" "),function(b){a[b]=this[b]},this);a.firstToBid=_.cloneDeep(this.firstToBid);return a};
Bridge.Contract.prototype.update=function(a){this.isComplete&&Bridge._reportError("Auction is already complete. Cannot make another call");var b=a.getLevel(),c=a.getSuit(),d=a.getDirection();switch(c){case "p":this.numPasses++;if(this.declarer&&3===this.numPasses||4===this.numPasses)this.isComplete=!0;break;case "x":this.declarer&&Bridge.areOpponents(this.declarer,d)&&!this.redoubled&&!this.doubled||Bridge._reportError("Double is not allowed at this point in the auction");this.doubled=!0;this.numPasses=
0;break;case "r":(!this.doubled||Bridge.areOpponents(this.declarer,d)||this.redoubled)&&Bridge._reportError("ReDouble is not allowed at this point in the auction");this.redoubled=!0;this.numPasses=0;break;default:(b<this.level||b===this.level&&Bridge.calls[c].index>=Bridge.calls[this.suit].index)&&Bridge._reportError(a.toString()+" is not allowed at this point in the auction"),this.redoubled=this.doubled=!1,this.numPasses=0,this.firstToBid[c][d]||(this.firstToBid[c][d]=d,this.firstToBid[c][Bridge.getPartner(d)]=
d),this.declarer=this.firstToBid[c][d],this.suit=c,this.level=b}};Bridge.Contract.prototype.toString=function(){var a="";this.level&&(a+=this.level,a+=this.suit,this.redoubled?a+="xx":this.doubled&&(a+="x"),a+=this.declarer);return a};Bridge||(Bridge={});Bridge.Play=function(a){this.deal=a;this.currentPlayNumber=1;this.plays=[];this.initialized=!1;this.trump=this.leader=null;this.triggerEvents=!0};Bridge.Play.prototype.initialize=function(){var a=this.deal.getAuction().getContract();a.isComplete||Bridge._reportError("Cannot set up play unless auction is complete","Bridge.Play constructor");this.trump=a.getSuit();this.leader=a.getLeader();this.initialized=!0};
Bridge.Play.prototype.getNextToPlay=function(){return 1===this.currentPlayNumber?this.leader:this.plays[this.currentPlayNumber-2].nextToPlay};
Bridge.Play.prototype.addPlayedCard=function(a,b){this.initialized||this.initialize();a=a.toLowerCase();b=b.toLowerCase();Bridge._checkSuit(a,"In Bridge.Play.addPlayedCard");Bridge._checkRank(b,"In Bridge.Play.addPlayedCard");if(this.deal){var c=this.deal.cards[a][b];c.play(this.getNextToPlay());var d=this.currentPlayNumber,c=new Bridge.PlayedCard(d,c),e=1===d?null:this.plays[d-2].getWinningCard();c.findWinningCard(e,this.trump);this.plays[d-1]=c;d=this.plays.length-d;0<d&&_.dropRight(this.plays,
d);this.playCard();this.onChange("addPlayedCard",a+b)}else Bridge._reportError("Cannot set up play without corresponding deal","In Bridge.Play.addPlayedCard")};Bridge.Play.prototype.removePlayedCard=function(){if(0<this.plays.length){var a=this.plays.pop();this.currentPlayNumber--;var b=a.getSuit(),a=a.getRank();this.played[b][a]=-1;this.onChange("removeCall",call.getCall())}};Bridge.Play.prototype.clearPlayedCards=function(){for(;0<this.plays.length;)this.removePlayedCard()};
Bridge.Play.prototype.playCard=function(){this.plays.length>=this.currentPlayNumber&&this.currentPlayNumber++};Bridge.Play.prototype.fromString=function(a){this.clearPlayedCards();for(var b=0;b<a.length;){var c=a[b++].toLowerCase();b>=a.length&&Bridge._reportError("Play ends unexpectedly on suit with no rank","In Play.fromString");var d=a[b++].toLowerCase();this.addPlayedCard(c,d)}};Bridge.Play.prototype.fromJSON=function(a){return this.fromString(a)};
Bridge.Play.prototype.toString=function(){for(var a="",b=0;b<this.plays.length;++b)a+=this.plays[b].toString();return a};Bridge.Play.prototype.toJSON=function(){return this.toString()};
Bridge.Play.prototype.onChange=function(a,b){if(this.triggerEvents&&!this.deal||this.deal.triggerEvents)Bridge.options.enableDebug&&console.log("play:changed "+a+" - "+b),$(document).trigger("play:changed",[this,a,b]);this.deal&&this.deal.triggerEvents&&(Bridge.options.enableDebug&&console.log("deal:changed "+a+" - "+b),$(document).trigger("deal:changed",[this.deal,a,b]))};Bridge||(Bridge={});Bridge.PlayedCard=function(a,b){var c=_.parseInt(a);(_.isNaN(c)||1>c||52<c)&&Bridge._reportError("Playnumber : "+a+" is not valid!","In Bridge.PlayedCard constructor");this.playNumber=c;this.card=b;this.nextToPlay=Bridge.getLHO(this.card.getDirection());this.winningCard=this;this.leadCard=this;this.ewTricks=this.nsTricks=0};Bridge.PlayedCard.prototype.getCard=function(){return this.card};Bridge.PlayedCard.prototype.getSuit=function(){return this.card.getSuit()};
Bridge.PlayedCard.prototype.getRank=function(){return this.card.getRank()};Bridge.PlayedCard.prototype.getDirection=function(){return this.card.getDirection()};Bridge.PlayedCard.prototype.getWinningCard=function(){return this.winningCard};Bridge.PlayedCard.prototype.getLeadCard=function(){return this.leadCard};
Bridge.PlayedCard.prototype.get=function(a){Bridge._checkRequiredArgument(a,"Property","In Call.get");switch(a){case "card":return this.getCard();case "suit":return this.getSuit();case "rank":return this.getRank();case "direction":return this.getDirection();case "winning_card":return this.getWinningCard();case "lead_card":return this.getLeadCard();default:Bridge._reportError("Unknown property "+a,"In Call.get")}};
Bridge.PlayedCard.prototype.findWinningCard=function(a,b){if(1!==this.playNumber%4&&a){this.leadCard=a.getLeadCard();var c=a.getSuit(),d=a.getRank(),e=this.getSuit(),f=this.getRank();c===b?e===b&&Bridge.isHigherRank(f,d)?this.winningCard=this:this.winningCard=a:e===b||e===c&&Bridge.isHigherRank(f,d)?this.winningCard=this:this.winningCard=a;0===this.playNumber%4&&(c=this.winningCard.getDirection(),Bridge.isNorthSouth(c)?this.nsTricks++:this.ewTricks++,this.nextToPlay=c)}else this.winningCard=this,
this.leadCard=this};Bridge.PlayedCard.prototype.toString=function(){var a;return a=""+this.card.toString()};Bridge.Deal.prototype.toHTML=function(){var a;a="<h3>Deal Information</h3>"+("Board : "+this.getBoard()+"<br/>");a+="Dealer : "+Bridge.directions[this.getDealer()].html+"<br/>";a+="Vulnerability : "+Bridge.vulnerabilities[this.getVulnerability()].html+"<br/>";a+="Notes : "+this.getNotes()+"<br/>";a+="<h3>Hands</h3>";for(var b in Bridge.directions)a+=this.getHand(b).toHTML()+"<br/>";a+="<h3>Auction</h3>";return a+=this.getAuction().toHTML()};
Bridge.embedHTML=function(a,b){0===$("#"+a).length?Bridge._reportError("Container with id : "+a+" does not exist!"):$("#"+a).empty().append(b)};Bridge._getID=function(a,b){return a?"id='"+a+"-"+b+"'":""};Bridge._getClasses=function(a,b){var c=[],c=_.union(c,a);_.each(a,function(a){b[a]&&(c=_.union(c,b[a]))},this);var d=c.join(" ");return d?"class='"+d+"'":""};Bridge._getData=function(a,b,c){var d=[],d=_.union(d,b);_.each(a,function(a){c[a]&&(d=_.union(d,c[a]))},this);return d.join(" ")};
Bridge._getTag=function(a,b){for(var c=0;c<b.length;++c)if(_.has(a.tags,b[c]))return a.tags[b[c]];return"div"};Bridge._openTag=function(a,b,c,d,e){if(!a)return"";e=Bridge.assignDefault(e,!0);a="<"+a;e&&(a+=" "+Bridge._getID(b.idPrefix,c[0]));a+=" "+Bridge._getClasses(c,b.classes);a+=" "+Bridge._getData(c,d,b.data);return a+">"};Bridge._closeTag=function(a){return a?"</"+a+">":""};
Bridge._generateHTMLModule=function(a,b,c,d){var e="",f=[a.prefix],l=Bridge._getTag(a,f),e=e+Bridge._openTag(l,a,f,[]);if(b)var f=[a.prefix+"-header"],m=Bridge._getTag(a,f),e=e+Bridge._openTag(m,a,f,[]),e=e+b+Bridge._closeTag(m);c&&(b=[a.prefix+"-content"],f=Bridge._getTag(a,b),e+=Bridge._openTag(f,a,b,[]),e+=c,e+=Bridge._closeTag(f));d&&(c=[a.prefix+"-footer"],b=Bridge._getTag(a,c),e+=Bridge._openTag(b,a,c,[]),e+=d,e+=Bridge._closeTag(b));return e+=Bridge._closeTag(l)};
Bridge._generateClasses=function(a,b){var c=[];_.each(b,function(b){a+="-"+b;c.push(a)},this);return c.reverse()};Bridge.getTableConfig=function(a){var b={};b[a]="table";b[a+"-header"]="thead";b[a+"-content"]="tbody";b[a+"-footer"]="tfoot";b[a+"-row"]="tr";b[a+"-column"]="td";b[a+"-field"]="span";return b};Bridge.getDivConfig=function(a){var b={};b[a]="div";b[a+"-header"]="div";b[a+"-content"]="div";b[a+"-footer"]="div";b[a+"-row"]="div";b[a+"-column"]="span";b[a+"-field"]="span";return b};
Bridge.getSpanConfig=function(a){var b={};b[a]="span";b[a+"-header"]="span";b[a+"-content"]="span";b[a+"-footer"]="span";b[a+"-row"]="span";b[a+"-column"]="span";b[a+"-field"]="span";return b};
Bridge.Hand.prototype.toBBODiagram=function(a){a=Bridge.assignDefault(a,{});_.defaults(a,{prefix:"hand-diagram",show:{},tags:{},data:{},classes:{},idPrefix:null,containerID:null,registerChangeHandler:!0});_.defaults(a.show,{direction:!0,name:!0,count:!1,suit:!0,cards:!0});var b=a.prefix;_.has(a.classes,b)?a.classes[b].push("bbo"):a.classes[b]=["bbo"];a.tags=Bridge.getTableConfig(a.prefix);return this.toHTML(a)};
Bridge.Hand.prototype.toHTML=function(a,b){b=Bridge.assignDefault(b,!1);a=Bridge.assignDefault(a,{});_.defaults(a,{prefix:"hand-diagram",show:{},tags:{},data:{},classes:{},idPrefix:null,containerID:null,alternateSuitColor:!1,registerChangeHandler:!1});var c=a.prefix;_.defaults(a.show,{direction:!1,name:!1,countInHeader:!1,countInContent:!1,suit:!0,cards:!0,text:!0,emptySuit:!0});var d=Bridge.getSpanConfig(c);_.defaults(a.tags,d);a.registerChangeHandler&&!a.idPrefix&&Bridge._reportError("idPrefix is required if change handler has to registered");
var d="",e=Bridge._generateClasses(c,["row","info"]),f=Bridge._getTag(a,e);if(a.show.direction||a.show.name){var d=d+Bridge._openTag(f,a,e,[]),l=[],m="",g="direction";if(a.show[g])var l=Bridge._generateClasses(c,["column",g]),m=Bridge._getTag(a,l),d=d+Bridge._openTag(m,a,l,[]),k=Bridge._generateClasses(c,["field",g]),h=Bridge._getTag(a,k),q=["data-"+g+"='"+this.get(g)+"'"],d=d+Bridge._openTag(h,a,k,q),d=d+this.get(g).toUpperCase(),d=d+Bridge._closeTag(h),d=d+Bridge._closeTag(m);g="name";if(a.show[g]){l=
Bridge._generateClasses(c,["column",g]);m=Bridge._getTag(a,l);d+=Bridge._openTag(m,a,l,[]);k=Bridge._generateClasses(c,["field",g]);h=Bridge._getTag(a,k);q=["data-"+g+"='"+this.get(g)+"'"];d+=Bridge._openTag(h,a,k,q);d+=this.get(g);if(a.show.countInHeader)var p="count",k=Bridge._generateClasses(c,["field",p]),h=Bridge._getTag(a,k),q=["data-"+p+"='"+this.get(p)+"'"],d=d+Bridge._openTag(h,a,k,q),d=d+("("+this.get(p)+")"),d=d+Bridge._closeTag(h);d+=Bridge._closeTag(h);d+=Bridge._closeTag(m)}d+=Bridge._closeTag(f)}var n=
"",r=0,k=a.alternateSuitColor?this.getAlternatingSuitOrder():Bridge.suitOrder;_.each(k,function(b){e=Bridge._generateClasses(c,["row",b]);f=Bridge._getTag(a,e);n+=Bridge._openTag(f,a,e,[]);g="suit";if(a.show[g]){l=Bridge._generateClasses(c,["column",g,b]);m=Bridge._getTag(a,l);n+=Bridge._openTag(m,a,l,[]);var d=Bridge._generateClasses(c,["field",g,b]),h=Bridge._getTag(a,d),p=["data-"+g+"='"+b+"'"];n+=Bridge._openTag(h,a,d,p);n+=Bridge.suits[b].html;n+=Bridge._closeTag(h);n+=Bridge._closeTag(m)}g=
"cards";if(a.show[g]){l=Bridge._generateClasses(c,["column",g,b]);m=Bridge._getTag(a,l);n+=Bridge._openTag(m,a,l,[]);var d=Bridge._generateClasses(c,["field",g,b]),h=Bridge._getTag(a,d),p=["data-suit='"+b+"'"],k="",q=0;_.each(Bridge.rankOrder,function(e){if(this.cards[b][e]){var f=this.showAsX[b][e]?"x":e;e=this.showAsX[b][e]?"x":Bridge.ranks[f].html;q++;d=Bridge._generateClasses(c,["field",g,b,f]);d.push(c+"-field-"+g+"-"+r);h=Bridge._getTag(a,d);k+=Bridge._openTag(h,a,d,["data-suit='"+b+"'","data-rank='"+
f+"'","data-card='"+b+f+"'","data-card-order='"+(14*(3-Bridge.suits[b].index)+("x"===f?13:12-Bridge.ranks[f].index))+"'"]);a.show.text&&(k+=e);k+=Bridge._closeTag(h);r++}},this);0===q&&a.show.emptySuit&&a.show.text&&(k+="-");n+=k;n+=Bridge._closeTag(m)}n+=Bridge._closeTag(f)},this);a.show.countInContent&&(p="count",k=Bridge._generateClasses(c,["field",p]),h=Bridge._getTag(a,k),q=["data-"+p+"='"+this.get(p)+"'"],n+=Bridge._openTag(h,a,k,q),n+="("+this.get(p)+")",n+=Bridge._closeTag(h));d=Bridge._generateHTMLModule(a,
d,n,"");a.containerID&&Bridge.embedHTML(a.containerID,d);!b&&a.registerChangeHandler&&(k=a.idPrefix+"-"+a.prefix,h="hand:changed."+k,$(document).off(h),$(document).on(h,{config:_.cloneDeep(a),hand:this,id:k,event:h,direction:this.getDirection()},function(a,b){if(b===a.data.hand)if(0===$("#"+a.data.id).length){var c=a.data.event;$(document).off(c)}else b.toHTML(a.data.config,!0)}));return d};
Bridge.Auction.prototype.toBBODiagram=function(a){a=Bridge.assignDefault(a,{});_.defaults(a,{prefix:"auction-diagram",show:{},tags:{},data:{},classes:{},idPrefix:null,containerID:null,registerChangeHandler:!0,addQuestionMark:!0});var b=a.prefix;a.show.direction=!0;_.has(a.classes,b)?a.classes[b].push("bbo"):a.classes[b]=["bbo"];a.tags=Bridge.getTableConfig(a.prefix);return this.toHTML(a)};
Bridge.Auction.prototype.toHTML=function(a,b){b=Bridge.assignDefault(b,!1);a=Bridge.assignDefault(a,{});_.defaults(a,{prefix:"auction-diagram",show:{},tags:{},data:{},classes:{},idPrefix:null,containerID:null,registerChangeHandler:!1,addQuestionMark:!0});var c=a.prefix;_.defaults(a.show,{direction:!1});var d=Bridge.getSpanConfig(c);_.defaults(a.tags,d);a.registerChangeHandler&&!a.idPrefix&&Bridge._reportError("idPrefix is required if change handler has to registered");var e="",f=Bridge._generateClasses(c,
["row","directions"]),d=Bridge._getTag(a,f),e=e+Bridge._openTag(d,a,f,[]),l=[],m="",g="direction",k=this.vulnerability;a.show[g]&&_.each(Bridge.directionOrder,function(b){l=Bridge._generateClasses(c,["column",g,b]);m=Bridge._getTag(a,l);e+=Bridge._openTag(m,a,l,[]);var d=Bridge._generateClasses(c,["field",g,b]);"b"!=k&&k!=b&&k!=Bridge.getPartner(b)||d.push("vulnerable");var f=Bridge._getTag(a,d);e+=Bridge._openTag(f,a,d,["data-"+g+"='"+b+"'"]);e+=b.toUpperCase();e+=Bridge._closeTag(f);e+=Bridge._closeTag(m)},
this);for(var e=e+Bridge._closeTag(d),h="",g="call",q=0,f=Bridge._generateClasses(c,["row","calls",q]),d=Bridge._getTag(a,f),h=h+Bridge._openTag(d,a,f,[]),p="w",f=!0;this.dealer!==p;)var f=!1,p=Bridge.getLHO(p),l=Bridge._generateClasses(c,["column",g,p]),m=Bridge._getTag(a,l),h=h+Bridge._openTag(m,a,l,[]),n=Bridge._generateClasses(c,["field",g,p]),r=Bridge._getTag(a,n),t=["data-"+g+"='' data-direction='"+p+"'"],h=h+Bridge._openTag(r,a,n,t),h=h+Bridge._closeTag(r),h=h+Bridge._closeTag(m);for(var s=
0;s<this.calls.length;++s){var u=this.calls[s],p=u.getDirection();"w"!==p||f||(h+=Bridge._closeTag(d),q++,f=Bridge._generateClasses(c,["row","calls",q]),d=Bridge._getTag(a,f),h+=Bridge._openTag(d,a,f,[]));l=Bridge._generateClasses(c,["column",g,p]);m=Bridge._getTag(a,l);h+=Bridge._openTag(m,a,l,[]);n=Bridge._generateClasses(c,["field",g,p]);r=Bridge._getTag(a,n);t=["data-"+g+"='"+u.toString()+"' data-direction='"+p+"'"];h+=Bridge._openTag(r,a,n,t);h+=u.toHTML();h+=Bridge._closeTag(r);h+=Bridge._closeTag(m);
f=!1}0<this.calls.length&&(p=Bridge.getLHO(p));!this.getContract().isComplete&&a.addQuestionMark&&("w"===p&&(q++,f=Bridge._generateClasses(c,["row","calls",q]),d=Bridge._getTag(a,f),h+=Bridge._closeTag(d),h+=Bridge._openTag(d,a,f,[])),l=Bridge._generateClasses(c,["column",g,p]),m=Bridge._getTag(a,l),h+=Bridge._openTag(m,a,l,[]),n=Bridge._generateClasses(c,["field",g,p]),r=Bridge._getTag(a,n),t=["data-"+g+"='?' data-direction='"+p+"'"],h+=Bridge._openTag(r,a,n,t),h=h+"?"+Bridge._closeTag(r),h+=Bridge._closeTag(m),
p=Bridge.getLHO(p));for(;"w"!==p;)l=Bridge._generateClasses(c,["column",g,p]),m=Bridge._getTag(a,l),h+=Bridge._openTag(m,a,l,[]),n=Bridge._generateClasses(c,["field",g,p]),r=Bridge._getTag(a,n),t=["data-"+g+"='' data-direction='"+p+"'"],h+=Bridge._openTag(r,a,n,t),h+=Bridge._closeTag(r),h+=Bridge._closeTag(m),p=Bridge.getLHO(p);h+=Bridge._closeTag(d);d=Bridge._generateHTMLModule(a,e,h,"");a.containerID&&Bridge.embedHTML(a.containerID,d);!b&&a.registerChangeHandler&&(h=a.idPrefix+"-"+a.prefix,q="auction:changed."+
h,$(document).on(q,{config:_.cloneDeep(a),auction:this,id:h,event:q},function(a,b){if(a.data.auction===b)if(0===$("#"+a.data.id).length){var c=a.data.event;$(document).off(c)}else b.toHTML(a.data.config,!0)}));return d};Bridge.getCallHTML=function(a){var b=a.length;if(1>b||2<b)return a;a=a.toLowerCase();Bridge._checkBid(a);if(1===b)return Bridge.calls[a].html;if(2===b)return a[0]+Bridge.calls[a[1]].html};
Bridge.getCardHTML=function(a){if(2!==a.length)return a;var b=a[1].toLowerCase();a=a[0].toLowerCase();"x"!==b&&Bridge._checkRank(b);Bridge._checkSuit(a);a=""+Bridge.suits[a].html;return a="x"===b?a+b:a+Bridge.ranks[b].html};Bridge.Call.prototype.toHTML=function(a){a="";return a=1===this.call.length?a+Bridge.calls[this.call].html:a+(this.call[0]+Bridge.calls[this.call[1]].html)};
Bridge.Contract.prototype.toHTML=function(){var a="";this.level&&(a+=this.level,a+=Bridge.calls[this.suit].html,this.redoubled?a+=Bridge.calls.r.html:this.doubled&&(a+=Bridge.calls.x.html),a+=" by "+Bridge.directions[this.declarer].html);return a};
Bridge.Deal.prototype.toCardDeck=function(a,b){b=Bridge.assignDefault(b,!1);a=Bridge.assignDefault(a,{});_.defaults(a,{prefix:"card-deck",show:{},tags:{},data:{},classes:{},idPrefix:null,containerID:null,registerChangeHandler:!1});var c=a.prefix;_.defaults(a.show,{title:!0,activeHand:!0,text:!0,assignedTo:!0,reset:!1});var d=Bridge.getTableConfig(c);_.defaults(a.tags,d);var d="",e=Bridge._generateClasses(c,["row","title"]),f=Bridge._getTag(a,e),d=d+Bridge._openTag(f,a,e,[]),l=[],m="",g="title";if(a.show[g]){var l=
Bridge._generateClasses(c,["column",g]),m=Bridge._getTag(a,l),d=d+Bridge._openTag(m,a,l,["colspan=13"]),k=Bridge._generateClasses(c,["field",g]),h=Bridge._getTag(a,k),q=[],d=d+Bridge._openTag(h,a,k,q),q="Assign / Unassign cards";a.show.activeHand&&(q="Assign Cards to Active Hand : "+Bridge.directions[this.getActiveHand()].name+" / Unassign from any hand");d=d+q+Bridge._closeTag(h);d+=Bridge._closeTag(m)}var d=d+Bridge._closeTag(f),p="",g="cards";_.each(Bridge.suitOrder,function(b){e=Bridge._generateClasses(c,
["row",g,b]);f=Bridge._getTag(a,e);var d=["data-suit='"+b+"'"];p+=Bridge._openTag(f,a,e,d);_.each(Bridge.rankOrder,function(e){var f=this.cards[b][e].getDirection();f||(f="");l=Bridge._generateClasses(c,["column",g,b,e]);f&&l.push("assigned");m=Bridge._getTag(a,l);d=["data-suit='"+b+"'","data-rank='"+e+"'","data-assignedto='"+f+"'"];p+=Bridge._openTag(m,a,l,d);k=Bridge._generateClasses(c,["field",g,b,e]);f?(k.push("assigned"),k.push("assigned-"+f)):k.push("unassigned");h=Bridge._getTag(a,k);p+=Bridge._openTag(h,
a,k,d);a.show.text&&(p+=Bridge.suits[b].html+Bridge.ranks[e].html);a.show.assignedTo&&f&&(p+="("+f.toUpperCase()+")");p+=Bridge._closeTag(h);p+=Bridge._closeTag(m)},this);p+=Bridge._closeTag(f)},this);var n="";a.show.reset&&(e=Bridge._generateClasses(c,["row","reset"]),f=Bridge._getTag(a,e),n+=Bridge._openTag(f,a,e,[]),l=[],m="",g="reset",l=Bridge._generateClasses(c,["column",g]),m=Bridge._getTag(a,l),n+=Bridge._openTag(m,a,l,["colspan=13"]),k=Bridge._generateClasses(c,["field",g]),h=Bridge._getTag(a,
k),q=[],n+=Bridge._openTag(h,a,k,q),n=n+"Reset/Clear Hand"+Bridge._closeTag(h),n+=Bridge._closeTag(m),n+=Bridge._closeTag(f));d=Bridge._generateHTMLModule(a,d,p,n);a.containerID&&(Bridge.embedHTML(a.containerID,d),$(document).trigger("card-deck:updated"));a.registerChangeHandler&&(q=a.idPrefix+"-"+a.prefix,$("#"+q).on("click","."+a.prefix+"-field-cards",{deal:this},function(a){try{var b=$(this).data("suit"),c=$(this).data("rank"),d=$(this).data("assignedto");d?a.data.deal.getHand(d).removeCard(b,
c):a.data.deal.getHand(a.data.deal.getActiveHand()).addCard(b,c)}catch(e){alert(e.message)}}),$("#"+q).on("click","."+a.prefix+"-field-reset",{deal:this},function(a){try{var b=a.data.deal;b.getHand(b.getActiveHand()).clearCards()}catch(c){alert(c.message)}}),b||(n="hand:changed."+q,$(document).off(n),$(document).on(n,{deal:this,config:_.cloneDeep(a),id:q,event:n},function(a,b){if(0===$("#"+a.data.id).length){var c=a.data.event;$(document).off(c)}else a.data.deal.toCardDeck(a.data.config,!0)})));return d};
Bridge.Auction.prototype.toBiddingBox=function(a,b){b=Bridge.assignDefault(b,!1);a=Bridge.assignDefault(a,{});_.defaults(a,{layout:"full",prefix:"bidding-box",show:{},tags:{},data:{},classes:{},idPrefix:null,containerID:null,registerChangeHandler:!1});_.defaults(a.show,{allpass:!0,undo:!0,reset:!0});var c=Bridge.getTableConfig(a.prefix);_.defaults(a.tags,c);c="concise"===a.layout?this._createConciseBiddingBox(a):"concise-level"===a.layout?this._createConciseBiddingBoxLevel(a):"concise-calls"===a.layout?
this._createConciseBiddingBoxCalls(a):this._createFullBiddingBox(a);a.containerID&&Bridge.embedHTML(a.containerID,c);if(a.registerChangeHandler){var d=a.idPrefix+"-"+a.prefix;$("#"+d).on("click","."+a.prefix+"-field-level.enabled",{auction:this},function(a){var b=$(this).data("level");a.data.auction.setSelectedLevel(b)});$("#"+d).on("click","."+a.prefix+"-field-calls.enabled",{auction:this},function(a){try{var b=$(this).data("call"),c=a.data.auction;"allpass"===b?c.addAllPass():"undo"===b?c.removeCall():
"reset"===b?c.clearCalls():c.addCall(b)}catch(d){alert(d.message)}});if(!b){var e="bidding-box:changed."+d;$(document).off(e);$(document).on(e,{config:_.cloneDeep(a),auction:this,id:d,event:e},function(a,b){if(b===a.data.auction)if(0===$("#"+a.data.id).length){var c=a.data.event;$(document).off(c)}else b.toBiddingBox(a.data.config,!0)})}}return c};
Bridge.Auction.prototype._createConciseBiddingBoxLevel=function(a){var b=this.getContract().allowedCalls(this.nextToCall),c=this.getSelectedLevel(),d=a.prefix,e=b.minimum_level,f="",b=Bridge._generateClasses(d,["row","level"]),l=Bridge._getTag(a,b),f=f+Bridge._openTag(l,a,b,[]);_.each(_.range(1,8),function(b){var g=Bridge._generateClasses(d,["column","level",b]),k=["data-level='"+b+"'"],h=Bridge._getTag(a,g);f+=Bridge._openTag(h,a,g,k);var g=Bridge._generateClasses(d,["field","level",b]),l=Bridge._getTag(a,
g);0!==b&&b===c&&g.push("selected");b>=e?g.push("enabled"):(g.push("disabled"),k.push("disabled"));f+=Bridge._openTag(l,a,g,k);0!==b&&(f+=b);f+=Bridge._closeTag(l);f+=Bridge._closeTag(h)},this);f+=Bridge._closeTag(l);return Bridge._generateHTMLModule(a,"",f,"")};
Bridge.Auction.prototype._createConciseBiddingBoxCalls=function(a){var b=this.getContract().allowedCalls(this.nextToCall),c=this.getSelectedLevel(),d=a.prefix,e="",f=Bridge._generateClasses(d,["row","calls"]),l=Bridge._getTag(a,f),e=e+Bridge._openTag(l,a,f,[]);_.each(Bridge.callOrder.slice().reverse(),function(f){var g=Bridge.isStrain(f)?Bridge.calls[f].html:Bridge.calls[f].text,k=Bridge._generateClasses(d,["column","calls",f]),h=Bridge.isStrain(f)?c+f:f,l=["data-suit='"+f+"'","data-call='"+h+"'"],
p=Bridge._getTag(a,k);e+=Bridge._openTag(p,a,k,l);var k=Bridge._generateClasses(d,["field","calls",f]),n=Bridge._getTag(a,k);c&&Bridge.isStrain(f);b[h]?k.push("enabled"):(k.push("disabled"),l.push("disabled"));e+=Bridge._openTag(n,a,k,l);e+=g;e+=Bridge._closeTag(n);e+=Bridge._closeTag(p)},this);e+=Bridge._closeTag(l);return Bridge._generateHTMLModule(a,"",e,"")};
Bridge.Auction.prototype._createConciseBiddingBox=function(a){var b=this.getContract().allowedCalls(this.nextToCall),c=this.getSelectedLevel(),d=a.prefix,e=b.minimum_level,f="",l="level",m=Bridge._generateClasses(d,["row","level"]),g=Bridge._getTag(a,m),k=null,h=null,f=f+Bridge._openTag(g,a,m,[]);_.each(_.range(0,8),function(b){k=Bridge._generateClasses(d,["column",l,b]);var n=["data-level='"+b+"'"];h=Bridge._getTag(a,k);f+=Bridge._openTag(h,a,k,n);var g=Bridge._generateClasses(d,["field",l,b]),m=
Bridge._getTag(a,g);0!==b&&b===c&&g.push("selected");b>=e?g.push("enabled"):(g.push("disabled"),n.push("disabled"));f+=Bridge._openTag(m,a,g,n);0!==b&&(f+=b);f+=Bridge._closeTag(m);f+=Bridge._closeTag(h)},this);l="calls";m=Bridge._generateClasses(d,["row",l]);g=Bridge._getTag(a,m);f+=Bridge._openTag(g,a,m,[]);_.each(Bridge.callOrder.slice().reverse(),function(e){var g=Bridge.isStrain(e)?Bridge.calls[e].html:Bridge.calls[e].text;k=Bridge._generateClasses(d,["column",l,e]);var m=Bridge.isStrain(e)?
c+e:e,q=["data-suit='"+e+"'","data-call='"+m+"'"];h=Bridge._getTag(a,k);f+=Bridge._openTag(h,a,k,q);var s=Bridge._generateClasses(d,["field",l,e]),u=Bridge._getTag(a,s);c&&Bridge.isStrain(e);b[m]?s.push("enabled"):(s.push("disabled"),q.push("disabled"));f+=Bridge._openTag(u,a,s,q);f+=g;f+=Bridge._closeTag(u);f+=Bridge._closeTag(h)},this);var f=f+Bridge._closeTag(g),q="",m=Bridge._generateClasses(d,["row","utilities"]),g=Bridge._getTag(a,m),q=q+Bridge._openTag(g,a,m,[]),k=[],h="",l="calls";_.each([{field:"allpass",
text:"All Pass",call:"allpass",bid:"p"},{field:"skip"},{field:"undo",text:"Undo",call:"undo",bid:"u"},{field:"skip"},{field:"reset",text:"Reset",call:"reset",bid:"u"}],function(c){k=Bridge._generateClasses(d,["column",l,c.field]);h=Bridge._getTag(a,k);var e=["data-bid='"+c.call+"'","data-call='"+c.call+"'"],f="skip"!==c.field?"colspan=2":"colspan=1";e.push(f);if(a.show[c.field]&&"skip"!==c.field){q+=Bridge._openTag(h,a,k,e);var f=Bridge._generateClasses(d,["field",l,c.field]),g=Bridge._getTag(a,f);
b[c.bid]?f.push("enabled"):(f.push("disabled"),e.push("disabled"));q+=Bridge._openTag(g,a,f,e);q+=c.text;q+=Bridge._closeTag(g)}else q+="<"+h+" "+f+">";q+=Bridge._closeTag(h)},this);q+=Bridge._closeTag(g);return Bridge._generateHTMLModule(a,"",f,q)};
Bridge.Auction.prototype._createFullBiddingBox=function(a){var b=this.getContract().allowedCalls(this.nextToCall),c=a.prefix,d="",e=Bridge._generateClasses(c,["row","special-bids"]),f=Bridge._getTag(a,e),d=d+Bridge._openTag(f,a,e,[]),l=[],m="",e=[{field:"pass",text:"Pass",call:"p",bid:"p"},{field:"skip"},{field:"double",text:"X",call:"x",bid:"x"},{field:"skip"},{field:"redouble",text:"XX",call:"r",bid:"r"}];_.each(e,function(e){l=Bridge._generateClasses(c,["column","calls",e.bid]);m=Bridge._getTag(a,
l);var f=["data-bid='"+e.call+"'","data-call='"+e.call+"'"];if("skip"!==e.field){d+=Bridge._openTag(m,a,l,f);var g=Bridge._generateClasses(c,["field","calls",e.bid]);b[e.bid]?g.push("enabled"):(g.push("disabled"),f.push("disabled"));var k=Bridge._getTag(a,g);d+=Bridge._openTag(k,a,g,f);d+=e.text;d+=Bridge._closeTag(k)}else d+="<"+m+"/>";d+=Bridge._closeTag(m)},this);var d=d+Bridge._closeTag(f),g="";_.each(_.range(1,8),function(d){var e=Bridge._generateClasses(c,["row","level",d]),f=Bridge._getTag(a,
e);g+=Bridge._openTag(f,a,e,[]);_.each(Bridge.callOrder.slice().reverse(),function(e){if(Bridge.isStrain(e)){var f=d+e,k=d+Bridge.calls[e].html;l=Bridge._generateClasses(c,["column","calls",d,e]);var p=["data-level='"+d+"'","data-bid='"+e+"'","data-call='"+f+"'"];m=Bridge._getTag(a,l);g+=Bridge._openTag(m,a,l,p);e=Bridge._generateClasses(c,["field","calls",d,e]);var q=Bridge._getTag(a,e);b[f]?e.push("enabled"):(e.push("disabled"),p.push("disabled"));g+=Bridge._openTag(q,a,e,p);g+=k;g+=Bridge._closeTag(q);
g+=Bridge._closeTag(m)}},this);g+=Bridge._closeTag(f)},this);var k="",e=Bridge._generateClasses(c,["row","utilities"]),f=Bridge._getTag(a,e),k=k+Bridge._openTag(f,a,e,[]),l=[],m="",e=[{field:"allpass",text:"All Pass",call:"allpass",bid:"p"},{field:"skip"},{field:"undo",text:"Undo",call:"undo",bid:"u"},{field:"skip"},{field:"reset",text:"Reset",call:"reset",bid:"u"}];_.each(e,function(d){l=Bridge._generateClasses(c,["column","calls",d.field]);m=Bridge._getTag(a,l);var e=["data-bid='"+d.call+"'","data-call='"+
d.call+"'"];if(a.show[d.field]&&"skip"!==d.field){k+=Bridge._openTag(m,a,l,e);var f=Bridge._generateClasses(c,["field","calls",d.field]),g=Bridge._getTag(a,f);b[d.bid]?f.push("enabled"):(f.push("disabled"),e.push("disabled"));k+=Bridge._openTag(g,a,f,e);k+=d.text;k+=Bridge._closeTag(g)}else k+="<"+m+"/>";k+=Bridge._closeTag(m)},this);k+=Bridge._closeTag(f);return Bridge._generateHTMLModule(a,d,g,k)};
